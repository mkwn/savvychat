<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<!--The reason there are two icon tags here is because there's a quirk in chrome where the favicon will not change unless both the icon and shortcut icon tags are changed-->
<link rel="shortcut icon" id="sicon" href="favicon.ico" />
<link rel="icon" id="icon" href="favicon.ico" />
<link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />
<style type="text/css">
body{
overflow: hidden;
margin: 0 !important;
}
h1,h2,h3,h4{
margin-top: 0;
}
h3,h4{
margin-bottom: 5px;
}

hr{
color: #EEE;
background-color: #EEE;
height: 3px;
border: None;
margin-left: 20px;
margin-right: 20px;
margin-bottom: 0;
}

#preview .code{
background-color: #BBF;
}
.callpost .code{
background-color: #FB9;
}
.topicpost .code{
background-color: #BF9;
}
#topic .code{
background-color: #DDD;
}
.notifypost .code{
background-color: #DDD;
}
div.mathplaceholderblock{
font-family: Courier New, monospace;
text-align: center;
}
span.mathplaceholderinline{
font-family: Courier New, monospace;
}

blockquote{
border: solid;
border-left: none;
border-right: none;
border-color: #EEE;
border-width: 3px;
margin-left: 20px;
margin-right: 20px;
}
#preview blockquote{
border-color: #BBF;
}
.callpost blockquote{
border-color: #FB9;
}
.notifypost blockquote{
border-color: #DDD;
}

#loadingContainer{
text-align: center;
}
#loadingContent{
text-align: center;
margin-left: auto;
margin-right: auto;
width: 150px;
background-color: #FFF;
border: solid;
border-top: none;
border-color: #DDD;
border-width: 3px;
}

#container{
text-align: center;
}
#content{
text-align: left;
margin-left: auto ;
margin-right: auto ;
width: 900px;
position: relative;
{% if not gadget %}
background-color: #FFF;
{% endif %}
border: solid;
border-top: none;
border-bottom: none;
border-color: #DDD;
border-width: 3px;
}
#header, #archive, #compose, #footer{
padding: 10px;
{% if gadget %}
padding-left: 0px;
padding-right: 0px;
{% endif %}
}

#header{
text-align: center;
padding-bottom: 30px;
}
.headerLeft{
position: absolute;
width: 200px;
text-align: right;
right: 10px;
}
#subtitle{
position: absolute;
width: 900px;
left: 0;
}
#helpTag{
position: absolute;
width: 200px;
text-align: left;
left: 10px;
}
#logoutTag{
position: absolute;
width: 200px;
text-align: right;
right: 10px;
}

#archive{
{% if not gadget %}
background-color: #EEE;
{% endif %}
}
#topic{
{% if gadget %}
background-color: #FFF;
padding-top: 4px;
padding-left: 5px;
padding-right: 5px;
-moz-border-radius: 5px;
border-radius: 5px;
{% endif %}
font-weight: bold;
margin-bottom: 15px;
height: 20px;
overflow: hidden;
white-space: nowrap;
}
#topic strong{
font-size: 120%;
}
#postlist{
overflow: auto;
overflow-x: hidden;
width: 880px;
height: 400px;
}
.post{
background-color: #FFF;
padding: 10px;
{% if gadget %}
-moz-border-radius: 5px;
border-radius: 5px;
padding: 5px;
{% endif %}
margin-top: 3px;

white-space: pre-wrap;      /* CSS3 */   
white-space: -moz-pre-wrap; /* Firefox */    
white-space: -pre-wrap;     /* Opera before 7 */
white-space: -o-pre-wrap;   /* Opera 7 */    
word-wrap: break-word;      /* IE */
}

.ellipsis{
color:red;
}

.joinedattop{
margin-top: 0;
border-top-right-radius: 0;
border-top-left-radius: 0;
-moz-border-radius-topright: 0;
-moz-border-radius-topleft: 0;
}

.joinedatbottom{
border-bottom-right-radius: 0;
border-bottom-left-radius: 0;
-moz-border-radius-bottomright: 0;
-moz-border-radius-bottomleft: 0;
}

.withscrollbar .post{
border-top-right-radius: 0;
border-bottom-right-radius: 0;
-moz-border-radius-topright: 0;
-moz-border-radius-bottomright: 0;
}

.author{

font-weight: bold;
margin-bottom: 5px;
}
.datelabel{
margin-left: 10px;
float: right;
text-align: right;
font-size: 70%;
{% if gadget %}
display: None;
{% endif %}
}
.callpost{
background-color: #FDC;
}
.topicpost{
background-color: #EFD;
}
.notifypost{
background-color: #EEE;
}
#previewpost{
background-color: #DDF;
}
#previewlabel{
margin-left: 10px;
float: right;
text-align: right;
color: #669;
}

#compose{
{% if not gadget %}
background-color: #DDD;
{% endif %}
}
#composefield{
{% if gadget %}
-moz-border-radius: 5px;
border-radius: 5px;
margin-top: -5px;
{% endif %}
-webkit-box-sizing: border-box;
-moz-box-sizing: border-box;
box-sizing: border-box;
width: 880px;
height: 100px;
margin-bottom: 10px;
}
#controls{
{% if gadget %}
-moz-border-radius: 5px;
border-radius: 5px;
background-color: #FFF;
{% endif %}
}
#postbutton{
height: 50px;
width: 150px;
}

#footer{
text-align: center;
}

#container{
display: none;
}
</style>
<!--[if lt IE 7]>
        <script type="text/javascript">alert("SavvyChat will almost certainly not work on your browser");</script>
<![endif]-->
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src='/_ah/channel/jsapi'></script>
{% if not disableMath %}
<script type="text/javascript" src="http://mathjax.org/mathjax/MathJax.js">
MathJax.Hub.Config({
        extensions: ["tex2jax.js","TeX/AMSmath.js", "TeX/AMSsymbols.js", "TeX/autobold.js","TeX/noUndefined.js"],
		{% if gadget %}
		messageStyle: "none",
		{% endif %}
		skipStartupTypeset: true,
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'] ]
        },
        "HTML-CSS": { availableFonts: ["TeX"] }
    });
</script>
{% endif %}
<script type="text/javascript">
//MathJax.Hub.Config({  tex2jax: {processEscapes: true}  });
//MathJax.Hub.Config({  extensions: ["TeX/AMSmath.js", "TeX/AMSsymbol.js", "TeX/autobold.js","TeX/noUndefined.js"]  });
{
//some global variables
var token = '{{ token }}';
var tokenid = '{{ tokenid }}';
var userid = '{{ userid }}';
var username = '{{ name }}';
var disableAlert = false;
{% if disableAlert %}
disableAlert = true;
{% endif %}
var gadget = false;
{% if gadget %}
gadget = true;
{% endif %}
var dopreview = true;
var mathpreview = true;
var disableMath = false;
{% if disableMath %}
disableMath = true;
{% endif %}
if(gadget){
	dopreview = false;
}
var denyretrieve = true;
{% if showarchive %}
denyretrieve = false;
{% endif %}
var verbose = true;//this specifies whether the header and footer are shown
var currPostID = 0;
var endquerycursor = '{{ endquerycursor }}';
var startquerycursor = '{{ startquerycursor }}';
var disableSend = false
var windowFocus = true;
var mute = false;
var socket;
}

//http://snipplr.com/view/3561/addclass-removeclass-hasclass/
function hasClass(ele,cls) {
	return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}
function addClass(ele,cls) {
	if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}
function removeClass(ele,cls) {
	if (hasClass(ele,cls)) {
    	var reg = new RegExp('(\\s|^)' + cls + '(\\s|$)');
		ele.className = ele.className.replace(reg,' ');
	}
}

//http://www.geekdaily.net/2007/07/04/javascript-cross-browser-window-size-and-centering/
function windowHeight(){
	if(!window.innerWidth)	{
		//IE
		if(!(document.documentElement.clientWidth == 0)){
			//strict mode
			return document.documentElement.clientHeight;
		}else{
			//quirks mode
			return document.body.clientHeight;
		}
	}else{
		//w3c
		return window.innerHeight;
	}
}
function windowWidth(){
	if(!window.innerWidth)	{
		//IE
		if(!(document.documentElement.clientWidth == 0)){
			//strict mode
			return document.documentElement.clientWidth;
		}else{
			//quirks mode
			return document.body.clientWidth;
		}
	}else{
		//w3c
		return window.innerWidth;
	}
}

//open a communication channel
function openChannel(){
	var channel = new goog.appengine.Channel(token);
	socket = channel.open();
	socket.onopen = onOpen;
	socket.onclose = onClose;
	socket.onerror = onClose;
	socket.onmessage = onMessage;
}

var excess = 0;
//send any message to server
function sendMessage(path, opt){
		path = validateMessage(path, opt);
		if(!path){
			return false;
		}
		//syncing=true;displayNote(path);syncing=false;
		var xhr = new XMLHttpRequest();
		xhr.open('POST', path, true);
		xhr.send();
		xhr.onreadystatechange = function(){
			if(xhr.readyState == 4){
				xhr.onreadystatechange = function(){};
				if(opt && opt.callback){
					opt.callback(xhr.responseText);
				}
			}
		};
		return xhr;
}

//check the message is not too long
function validateMessage(path, opt){
		//path += '?u='+ userid+'&t='+tokenid;
		if (opt && opt.param){
			path += '?' + opt.param;
		}
		if(path.length > 2018){
			//this seems to be the limit to send in a single post
			excess = path.length - 2018;//2048 character limit for queries, this seems to be the practical limit
			return false;
		}
		return path;
}

//on establishing a connection
function onOpen(){
	//sendMessage('/opened');
	sync();
}
var allowance = {};
function allowSend(allow,cause){
	allowance[cause] = allow;
	for(var cause in allowance){
		if(!allowance[cause]){
			disableSend = true;
			document.getElementById('postbutton').disabled = true;
			return;
		}
	}
	disableSend = false;
	document.getElementById('postbutton').disabled = false;
}

//var badChannelTimeout;
//when the connection expires
function onClose(){
	socket.onclose = function(){};
	socket.onerror = function(){};
	socket.close();
	var callback = function(response){
		if(!response){
			if(!windowFocus&&!alerted){
				if(!disableAlert&&!mute){
					playAlert("error");
				}
			}
			setIcon("error.ico");
			document.title = "! SavvyChat";
			alerted = false;
			displayNote("Connection error. Please [[reload SavvyChat@@javascript:location.reload();]].");
			sendMessage('/closed', {param: 'u=' + userid + '&t=' + tokenid});
			return;
		}
		var arr = response.split("@@")
		tokenid = arr.shift();
		token = arr.join("@@");
		openChannel();
		allowSend(true,"error");
	};
	sendMessage('/token',{callback:callback, param: 't=' + tokenid});
	//badChannelTimeout = setTimeout(function(){
		//displayNote("Session expired or failed. Savvychat will attempt to aquire a new connection, but possibly you may need to refresh the page.");});
	//sendMessage('/closed');
	allowSend(false,"error");
	//alert("SavvyChat session expired or broke.");
}

function displayNote(text){
	var post = {content:"|notify|"+text, author:"SavvyChat", date:"", recipients:[]};
	recievePost(post);
}

var sounds = {};
function playAlert(type){
	//play sound
	if(typeof(Audio) == 'undefined'){
		//this only works in IE
		document.all.IEsound.src = "sounds/"+type+".wav";
	}else{
		//HTML5 version
		sounds[type].play();
		sounds[type] = new Audio("sounds/"+type+".wav");
	}
}

//helper function for setIcon
function newIconLink(path,id,rel){
	var head = document.getElementsByTagName("head")[0];
	head.removeChild(document.getElementById(id));
	
	var newIcon = document.createElement("link");
	newIcon.rel = rel;
	newIcon.id = id;
	newIcon.type = "image/x-icon";
	newIcon.href = "icons/" + path;
	head.appendChild(newIcon);
}

//http://softwareas.com/dynamic-favicons
//set the favicon (as an alert)
function setIcon(path){
	//first, check browser is not IE8 or older, where this is not possible
	//http://obvcode.blogspot.com/2007/11/easiest-way-to-check-ie-version-with.html
	var version = 999; // we assume a sane browser
    if (navigator.appVersion.indexOf("MSIE") != -1)
		// bah, IE again, lets downgrade version number
		version = parseFloat(navigator.appVersion.split("MSIE")[1]);
	if(version<9){
		return;
	}
	
	if(!path) path = "favicon.ico";
	
	newIconLink(path,"icon","icon");
	newIconLink(path,"sicon","shortcut icon");
	
	//some browsers require the page content to change before updating the favicon.
	var shim = document.createElement('iframe');
	shim.width = shim.height = 0;
	document.body.appendChild(shim);
	shim.src = "http://a";
	document.body.removeChild(shim);
}

function gotCalled(post){
	if(post.recipients&&post.recipients.length!=0){
		if(post.recipients[0]=="all"||post.recipients.indexOf(username.toLowerCase())!=-1){
			return true;
		}
	}
	return false;
}

var alerted = false;
//on recieving any message from the server
function onMessage(message){
	var m = JSON.parse(message.data);
	if(m.content){
		if(syncing){
			syncInterrupt = true;
			return;
		}
		//this was a post
		recievePost(m);
		//play a special tone when someone calls you, no matter what
		//make function ifcalled(post)
		if(gotCalled(m)&&!mute){
			//play the tone
			playAlert("call");
		}
		
		if(!windowFocus&&!alerted){
			setIcon("alert.ico");
			document.title="* SavvyChat";
			if(!disableAlert&&!gotCalled(m)&&!mute){
				playAlert("alert");
			}
			alerted = true;
		}
		return;
	}
	/*if(m.verify){
		//this was a verification
		clearTimeout(badChannelTimeout);
	}*/
	/*if(m.posts){
		//this was an archive retrieval
		document.getElementById("viewarchivetag").innerHTML='<a href="" onclick="retrieveArchive();return false;">^ view older ^</a>'
		recieveArchive(m.posts);
		endquerycursor = m.cursor;
		if(!m.showarchive){
			document.getElementById("viewarchivetag").style.display = "None"
		}
	}*/
}

function logout(){
	sendMessage('/closed', {param: 'u=' + userid + '&t=' + tokenid});
	location.href="{{ logouturl }}";
}

//send a new post to the server
function sendPost(){
	var text = document.getElementById("composefield").value.replace(/\r/g,"");
	//get meta in case it's an option, in that case we want to set the option and not send
	var meta = "";
	var metahead;
	if(/^\|+([^\|]+?)(\|+|$)([\s\S]*)/.test(text)){
		meta = RegExp.$1;
		//worktext = RegExp.$3;
		meta = meta.toLowerCase().replace(/\s/g,"");
		metahead = meta.split(":")[0]
		switch(metahead){
		case "logout":
			//logout
			logout();
			return;
			break;
		case "hf":
			//header and footer
			verbose = !verbose;
			wh = 0;//force a refit
			fitWindow();
			return;
			break;
		case "help":
			//help
			openHelp();
			return;
			break;
		case "tone":
			//alert tone
			document.getElementById("alertcheck").checked = !document.getElementById("alertcheck").checked;
			toggleAlert(document.getElementById("alertcheck"));
			return;
			break;
		case "mute":
			//mute
			mute = !mute;
			return;
			break;
		case "preview":
			//preview
			document.getElementById("previewcheck").checked = !document.getElementById("previewcheck").checked;
			togglePreview(document.getElementById("previewcheck"));
			return;
			break;
		case "math":
			//math in preview
			mathpreview = !mathpreview;
			return;
			break;
		case "archive":
			//retrieve archive
			retrieveArchive();
			return;
			break;
		case "sync":
			//sync
			//sendMessage("/test",{callback:function(response){displayNote(response);}})
			sync();
			return;
			break;
		case "upload":
			//open upload dialog box
			showUpload();
			return;
			break;
		}
	}
	
	if(disableSend) return;
	
	//if(text == "") return;
	var callback = function(response){
		//i should actually queue here
		allowSend(true,"post");
	};
	var enctext = encodeURIComponent(text);
	
	if(metahead == "call"){
		var enchtml = encodeURIComponent(getHTMLfromSavvyCode(text, false, username, true).html);
		var encrec = encodeURIComponent(meta.replace(/^.*?\:|.*/,""));
		if(encrec == "") encrec = "all";
		if (!validateMessage('/call', {param: 'h=' + enchtml + '&r=' + encrec})){
			displayNote('Tagged message too long, was not sent. Remove "' + metahead + '" tag from your message or shorten it.');
			return;
		}
	}
	
	if (sendMessage('/post', {param: 'p=' + enctext, callback: callback})){
		//yay
		if(metahead == "call"){
			//send html version for email
			sendMessage('/call', {param: 'h=' + enchtml + '&r=' + encrec});
		}
	}else{
		if(meta != ""){
			displayNote('Tagged message too long, was not sent. Remove "' + metahead + '" tag from your message or shorten it.');
			return;
		}
		var partNo = 1;
		var blockSize = enctext.length - excess; //i don't want to hardcode it in case i change something in sendMessage
		processParts(partNo, blockSize, text, enctext)
	}
	document.getElementById("preview").innerHTML = "";
	document.getElementById("authorpreview").innerHTML = username + ":";
	document.getElementById("composefield").value = "";
	allowSend(false,"post");
	//recievePost({content:document.getElementById("composefield").value,author:username,date:"1/3/11, 13:30 EST"});
}

function processParts(partNo, blockSize, text, enctext){
	var meta = encodeURIComponent("|cont:" + (partNo-1) + "," + partNo + "|");
	var available = blockSize - meta.length;
	var part = enctext.substr(0, available);
	var escIdx = part.substr(part.length-2,2).indexOf("%");
	if(escIdx != -1){
		//we got a portion of an escape sequence
		available -= 2 - escIdx;
		part = part.substr(0, available);
	}
	//we might still have a portion of a unicode escape sequence
	while(1){
		var clearpart;
		try{
			clearpart = decodeURIComponent(part);
		}catch(err){
			clearpart = String.fromCharCode(text.charCodeAt(0)+1);
		}
		if(clearpart == text.substr(0,clearpart.length)){
			//we're good
			text = text.substr(clearpart.length);
			break;
		}
		available -= 3;
		part = part.substr(0, available);
	}
	enctext = enctext.substr(available);
	var callback = function(response){
		processParts(partNo+1, blockSize, text, enctext);
	};
	var postcontent = meta + part
	if(enctext == ""){
		//done
		//allowSend(true);
		//callback = function(response){}
		callback = function(response){
			allowSend(true,"post");
		};
		postcontent = encodeURIComponent("|cont:" + (partNo-1) + ",0|") + part
	}
	sendMessage('/post', {param: 'p=' + postcontent, callback: callback});
}

var retrieving = false;
//call the server for some archive
function retrieveArchive(){
	if(retrieving||denyretrieve) return;
	var callback = function(response){
		var m = JSON.parse(response);
		document.getElementById("viewarchivetag").innerHTML='<a href="" onclick="retrieveArchive();return false;">^ view older ^</a>'
		showPreview();
		recieveArchive(m.posts);
		retrieving = false;
		endquerycursor = m.cursor;
		if(!m.showarchive){
			document.getElementById("viewarchivetag").style.display = "None";
			denyretrieve = true;
		}
	};
	retrieving = true;
	sendMessage('/retrieve', {param: 'c=' + encodeURIComponent(endquerycursor), callback: callback});
	document.getElementById("viewarchivetag").innerHTML = "loading...";
	//using AJAX for the reply seems marginally more reliable than COMET, but I'm not certain. Original COMET code is commented out in onMessage.
}

var syncInterrupt = false;
var syncing = false
//sync messages that may have not been recieved in COMET
function sync(){
	if(syncing) return;
	var callback = function(response){
		var m = JSON.parse(response);
		startquerycursor = m.cursor;
		recieveSync(m.posts);
		syncing = false;
		showPreview();
		if(syncInterrupt){
			sync();
		}
	};
	sendMessage('/sync', {param: 'c=' + encodeURIComponent(startquerycursor), callback: callback});
	syncing = true;
	syncInterrupt = false;
}

//process the archive
function recieveArchive(posts){
	//insert new posts
	//var postlist=document.getElementById("archivelist");
	//var interdiv=postlist.firstChild;
	for(var i=0;i<posts.length;i++){
		recievePost(posts[i],true,true);
	}
	//if (interdiv.previousSibling.childNodes[1].innerHTML==interdiv.childNodes[1].innerHTML){
		//interdiv.childNodes[1].style.display="None";
	//}
}

//process the sync
function recieveSync(posts){
	//first, remove all unsynced posts
	var postlist = document.getElementById("archivelist");
	for (var postidx = postlist.childNodes.length - 1;postidx >= 0;postidx --){
		var post = postlist.childNodes[postidx];
		if(post.className && !hasClass(post,"synced")){
			postlist.removeChild(post);
		}
	}
	//insert new posts
	//var interdiv = postlist.firstChild
	for(var i=posts.length-1;i>=0;i--){
		recievePost(posts[i]);
	}
	//if (interdiv.previousSibling.childNodes[1].innerHTML==interdiv.childNodes[1].innerHTML){
		//interdiv.childNodes[1].style.display="None";
	//}
}

//show/hide upload dialog
//var uploading = false;
function loadiFrame(){}
function hideUpload(){
	//alert(document.getElementById("uploadinput").value);
	//uploading = false;
	allowSend(true,"upload");
	document.getElementById("uploadform").style.display = "none";
	//document.getElementById("composefield").value = cachedText;
	cachedText = document.getElementById("composefield").style.visibility = "visible";//disabled = false;
	document.getElementById("composefield").focus();
}
function showUpload(){
	//uploading = true;
	allowSend(false,"upload");
	//cachedText = document.getElementById("composefield").value;
	//document.getElementById("composefield").value = "";
	document.getElementById("composefield").style.visibility = "hidden";//disabled = true;
	document.getElementById("uploadform").style.display = "block";
	document.getElementById("uploadinput").focus();
}

//check there's a file selected
function validateFile(){
	element = document.getElementById("uploadinput");
	if(element.value == ""){
		document.getElementById("uploadbutton").disabled = true;
	}else{
		document.getElementById("uploadbutton").disabled = false;
	}
}

//helper function since we require to hash the 3 different escaping tags in both autoquote() and getHTMLfromSavvyCode()
function hashstuff(text,codehash,mathhash,linkhashname,linkhashurl){
	var worktext = text;
	var output = "";
	while(1){
		//get the first occurrence of an escape tag, hash that away and keep going
		var codeparts = worktext.split("`");
		var mathparts = worktext.split("$$");
		var linkparts = worktext.split("[[");
		
		if(codeparts[0].length == mathparts[0].length && codeparts[0].length == linkparts[0].length){
		//we are done
			output += worktext;
			break;
		}
		
		var firstIndex = Math.min(codeparts[0].length, mathparts[0].length, linkparts[0].length);
		if(codeparts[0].length == firstIndex){
			output += codeparts.shift()+"`";
			//the carriage return is stripped later so we can use it to ensure tags aren't misinterpreted when decoding
			codehash.push(codeparts.shift().replace(/\$\$/g,"$\r$\r").replace(/\[\[/g,"[\r[\r"));
			worktext = codeparts.join("`");
		}else if(linkparts[0].length == firstIndex){
			output += linkparts.shift()+"[[";
			var remainder = linkparts.join("[[");
			linkparts = remainder.split("]]");
			//the carriage return is stripped later so we can use it to ensure tags aren't misinterpreted when decoding
			//we split the link into its label and URL and if no label is defined, give it the URL as the label
			linkdata = linkparts.shift().replace(/\$\$/g,"$\r$\r").replace(/\[\[/g,"[\r[\r").split("@@");
			if(linkdata.length == 1){
				linkdata.unshift(linkdata[0]);
			}
			//If the url is not prefixed with a protocol, add one
			if(!/^(ht|f)tp(s?)\:\/\/|^javascript:/.test(linkdata[1])){
				linkdata[1] = "http://"+linkdata[1];
			}
			linkhashurl.push(linkdata[1].replace(/\s/g,""));
			linkhashname.push(linkdata[0]);
			worktext = linkparts.join("]]");
		}else if(mathparts[0].length == firstIndex){
			output += mathparts.shift()+"$$";
			mathhash.push(mathparts.shift().replace(/\n/g," "));
			worktext = mathparts.join("$$");
		}
	}
	return output;
}

function formatQuote(content){
	var worktext = content.replace(/^\|\|[\s\S]*?\|\|/,"").replace(/\r/g,"");
	if(/^\|+([^\|]+?)(\|+|$)([\s\S]*)/.test(worktext)){
		//remove meta if necessary
		worktext = RegExp.$3;
	}
	
	//find something formatted like a link
	worktext = "\r" + worktext + "\r";
	worktext = worktext.replace(/(\s(&gt;)*)((ht|f)tp(s?)\:\/\/[\S]*)(\s)/g,"$1[[$3]]$6");
	
	//hash code and math
	var codehash = [];
	var mathhash = [];
	var linkhashname = [];
	var linkhashurl = [];
	
	var output = hashstuff(worktext,codehash,mathhash,linkhashname,linkhashurl)
	
	//add quote tags
	output = ">" + output.replace(/\n/g,"\n>");
	
	//close open formatting tags
	output = output.replace(/\*\*([\s\S]*?)$/,'**$1**');
	output = output.replace(/\/\/([\s\S]*?)$/,'//$1//')
	output = output.replace(/__([\s\S]*?)$/,'__$1__');
	
	//put back code
	codeparts = output.split("`");
	output = interleave(codeparts,codehash,'`','`','`','`')
	//put back text part of links
	linkparts = output.split("[[");
	output = interleave(linkparts,linkhashname,'\r[\r[\r','@@[[]]','\r[\r[\r','@@[[]]');
	//put back links
	linkparts = output.split("[[");
	output = interleave(linkparts,linkhashurl,'','','','');	
	
	//simplify link format
	output = output.replace(/\[\r\[\r(.*?)@@\1\]\]/g,"[[$1]]");
	
	//put back math
	mathparts = output.split("$$");
	output = interleave(mathparts, mathhash,'$$','$$','$$',' $$');
	var textarea = document.getElementById("composefield");
	return output.replace(/\r/g,'');
}

//append the textbox with a quote of another post
function autoquote(content,author,date){
	output = ">**" + author + " @ " + date + ":**\n" + formatQuote(content);
	
	var textarea = document.getElementById("composefield");
	var textvalue = textarea.value.replace(/\r\n/g,"\n");
	var selection = getSelectionPos(textarea);
	var pretext = textvalue.substr(0,selection.startPos)
	var posttext = textvalue.substr(selection.endPos)
	if(pretext.length != 0 && pretext.charAt(pretext.length-1) != "\n") pretext += "\n";
	if(posttext.length != 0 && posttext.charAt(0) != "\n") posttext = "\n" + posttext;
	textarea.value = pretext + output + posttext;
	setSelectionPos(textarea, pretext.length, pretext.length + output.length);
	/*if(textarea.value.replace(/\s/g,"") == ""){
		textarea.value = output;
	}else{
		textarea.value += "\n" + output;
	}*/
	showPreview();
}

//shorthand function because this gets used a lot. Queues a function for after math is finished typesetting.
function MJQ(arr){
	if(!disableMath)MathJax.Hub.Queue(arr);
}

//shorthand function to typeset math in an element
function MJQT(id){
	if(!disableMath)MathJax.Hub.Queue(["Typeset",MathJax.Hub,id]);
}

var appendChain = [];//for long messages
var prependChain = [];
var chainOpen = true;//are all the posts loaded part of a long message?
//process post and add to list
function recievePost(post,ignoretopics,prepend){
	var cachedmathpreview = mathpreview;
	var parsedObj =	getHTMLfromSavvyCode(post.content, true, post.author);
	var postdate;
	if(post.date == ""){
		postdate = new Date();
	}else{
		postdate = new Date(parseFloat(post.date)*1000);
	}
	var parsedDate = formatDate(postdate);
	var classtext = "";
	var metahead = parsedObj.meta.split(":")[0];
	if(metahead == "cont"){
		//long message
		var anchors = parsedObj.meta.split(":")[1].split(",")
		text = post.content.substr(("|"+parsedObj.meta+"|").length)//I can only do this because |cont | is never entered by the user
		var html;
		if(!prepend){
			if(appendChain.length == 0 || appendChain[appendChain.length-1].anchors[1] != anchors[0] || appendChain[0].author != post.author){
				//new chain
				appendChain = [{content:text,anchors:anchors,author:post.author,divId:'post' + currPostID}];
				if(chainOpen){
					prependChain = [{content:text,anchors:anchors,author:post.author,divId:'post' + currPostID}];
				}
			}else{
				appendChain.push({content:text,anchors:anchors,author:post.author,divId:appendChain[0].divId});
				if(chainOpen){
					prependChain.push({content:text,anchors:anchors,author:post.author,divId:appendChain[0].divId});
				}
				var totaltext = "";
				for(var i = 0; i < appendChain.length; i ++){
					totaltext += appendChain[i].content;
				}
				html = getHTMLfromSavvyCode(totaltext, true, post.author).html;
				if(anchors[1] != "0"){
					html += '<span class="ellipsis" title="incomplete post">...</span>';
				}
				document.getElementById(appendChain[0].divId).childNodes[2].innerHTML = html;
				var date = document.getElementById(appendChain[0].divId).firstChild.firstChild.innerHTML;
				document.getElementById(appendChain[0].divId).firstChild.firstChild.onclick = function(){
					autoquote(totaltext,post.author,date);
					return false;
				}
				if(anchors[1] == "0"){
					//done
					chainOpen = false;
					appendChain = [];
				}
				return;
			}
		}else{
			if(prependChain.length == 0 || prependChain[0].anchors[0] != anchors[1] || prependChain[0].author != post.author){
				//new chain
				prependChain = [{content:text,anchors:anchors,author:post.author,divId:'post' + currPostID}];
				if(chainOpen){
					appendChain = [{content:text,anchors:anchors,author:post.author,divId:'post' + currPostID}];
				}
			}else{
				prependChain.unshift({content:text,anchors:anchors,author:post.author,divId:prependChain[0].divId});
				if(chainOpen){
					appendChain.unshift({content:text,anchors:anchors,author:post.author,divId:prependChain[0].divId});
				}
				var totaltext = "";
				for(var i = 0; i < prependChain.length; i ++){
					totaltext += prependChain[i].content;
				}
				html = getHTMLfromSavvyCode(totaltext, true, post.author).html;
				if(anchors[0] != "0"){
					html = '<span class="ellipsis" title="incomplete post">...</span>' + html;
				}

				document.getElementById(prependChain[0].divId).childNodes[2].innerHTML = html;
				document.getElementById(prependChain[0].divId).firstChild.firstChild.onclick = function(){
					autoquote(totaltext,post.author,parsedDate);
					return false;
				}
				document.getElementById(prependChain[0].divId).firstChild.firstChild.innerHTML = parsedDate;
				if(anchors[0] == "0"){
					//done
					chainOpen = false;
					prependChain = [];
				}
				return;
			}
		}
		if(anchors[0] != "0"){
			parsedObj.html = '<span class="ellipsis" title="incomplete post">...</span>' + parsedObj.html;
		}else{
			//done
			chainOpen = false;
			prependChain = [];
		}
		if(anchors[1] != "0"){
			parsedObj.html += '<span class="ellipsis" title="incomplete post">...</span>';
		}else{
			//done
			chainOpen = false;
			appendChain = [];
		}
	}else{
		chainOpen = false;
		if(prepend){
			prependChain = [];
		}else{
			appendChain = [];
		}
	}
	if(metahead == 'topic'){
		classtext = ' topicpost';
		if(!ignoretopics){
			document.getElementById("topic").innerHTML = parsedObj.html;
			MJQT("topic");
		}
	}else if(metahead == "notify"){
		//undocumented meta to send a notification
		scrollLocked = true;
		scrollDown();
		classtext = ' notifypost';
	}else{
		if(gotCalled(post)){
			classtext = ' callpost';
		}
	}
	var quoteHTML = '<a>'+parsedDate+'</a>';
	//if(metahead != "cont"){
		//var escapedPost = post.content.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,"\\&quot;");
		//quoteHTML = '<a href="" onclick="autoquote(&quot;'+escapedPost+'&quot;,&quot;'+post.author+'&quot;,&quot;'+parsedDate+'&quot;);return false;" title="quote this post">'+parsedDate+'</a>';
	//}
	var divHTML='<div class="datelabel">'+quoteHTML+'</div><span class="author">'+parsedObj.authortext+'</span><span class="postcontent">' + parsedObj.html + '</span>';
	var newdiv = document.createElement('div');
	newdiv.innerHTML = divHTML;
	newdiv.firstChild.firstChild.href = "";
	newdiv.firstChild.firstChild.title = "quote this post";
	newdiv.firstChild.firstChild.onclick = function(){
		autoquote(post.content,post.author,parsedDate);
		return false;
	}
	newdiv.id = 'post' + currPostID;
	newdiv.className = "post" + classtext;
	if(syncing || !socket || retrieving){
		//AJAX not comet, flag that
		addClass(newdiv,"synced")
	}
	var postlist = document.getElementById("archivelist");
	if(!prepend){
		//append
		//hide author label for repeated posts by the same author
		if(postlist.lastChild){
			if(parsedObj.html != ""){
				if(postlist.lastChild.childNodes[1].innerHTML == parsedObj.authortext){
					newdiv.childNodes[1].style.display = "None";
					addClass(newdiv,"joinedattop");
					addClass(postlist.lastChild,"joinedatbottom");
					//newdiv.style.marginTop = "0";
					//newdiv.style.paddingTop = "0";
					//postlist.lastChild.style.paddingBottom = "0";
					//postlist.lastChild.innerHTML += "<hr />";
				}
			}
		}
		postlist.appendChild(newdiv);
	}else{
		//prepend
		//hide author label for repeated posts by the same author
		if(postlist.firstChild){
			if(parsedObj.html != ""){
				if(postlist.firstChild.childNodes[1].innerHTML == parsedObj.authortext){
					postlist.firstChild.childNodes[1].style.display = "None";
					addClass(newdiv,"joinedatbottom");
					addClass(postlist.firstChild,"joinedattop");
					//postlist.firstChild.style.marginTop = "0";
					//postlist.firstChild.style.paddingTop = "0";
					//newdiv.style.paddingBottom = "0";
					//newdiv.innerHTML += "<hr />";
				}
			}
		}
		postlist.insertBefore(newdiv,postlist.firstChild)
	}
	MJQT("post"+currPostID);
	scrollDown();
	MJQ([scrollDown]);
	currPostID++;
}

//http://www.electrictoolbox.com/pad-number-zeroes-javascript/
function pad(number, length) {
    var str = '' + number;
    while (str.length < length) {
        str = '0' + str;
    }   
    return str;
}

function formatDate(d){
	var h=pad(d.getHours(),2);
	var m=pad(d.getMinutes(),2);
	var Y=pad(d.getFullYear(),4);
	var M=pad(d.getMonth()+1,2);
	var D=pad(d.getDate(),2);
	return Y+"-"+M+"-"+D+", "+h+":"+m;
}

var helpWindow;
function openHelp(){
	if(helpWindow==null||helpWindow.closed){
		helpWindow=window.open('help.htm','','menubar=no,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes,height=600,width=600');
	}else{
		helpWindow.location='help.htm';
	}
	helpWindow.focus();
	return false;
}

//update the content of the preview post
var cachedText = "";
function showPreview(){
	var composetext = document.getElementById("composefield").value;
	if(composetext == ""){
		allowSend(false,"empty");
	}else{
		allowSend(true,"empty");
	}
	//if(uploading) return;
	if(cachedText == composetext) return;
	cachedText = composetext;
	if(!dopreview){
		return;
	}
	
	var parsedObj = getHTMLfromSavvyCode(composetext, mathpreview, username);
	
	document.getElementById("preview").innerHTML = parsedObj.html;
	document.getElementById("authorpreview").innerHTML = parsedObj.authortext;
	if(mathpreview){
		MJQT("preview");
	}
	scrollDown();
	MJQ([scrollDown]);
}

//turn my formatting syntax into HTML for display
function getHTMLfromSavvyCode(savvyCode, domath, author, compress){
	if(disableMath){
		domath = false;
	}
	
	if(compress == undefined) compress = false;
	
	//escape stuff
	var worktext = savvyCode.replace(/\r/g,"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/\\\(/g,"\\<a></a>(");
	
	//first check for a meta tag at the beginning of the text
	var authortext=author + ": ";
	var meta = "";
	var metahead = "";
	var multiline = true;
	if(/^\|+([^\|]+?)(\|+|$)([\s\S]*)/.test(worktext)){
		meta = RegExp.$1;
		worktext = RegExp.$3;
		meta = meta.toLowerCase().replace(/\s/g,"");
		var parts = meta.split(":");
		metahead = parts[0]
		var str;//helper string for some options
		switch (metahead){
		case "topic":
			//topics don't have any multiline stuff
			worktext = worktext.replace(/\n/g," ");
			multiline = false;
			authortext = author + " changed topic: ";
			break
		case "img":
			var url = worktext.replace(/\n/g,"")
			var onload = "setTimeout(&quot;scrollDown();ww=0;fitWindow();&quot;,1);"
			return {meta:'img',html:'<br /><a target="_blank" href="' + url + '"><img onerror="' + onload + '" onload="' + onload + '" src="' + url + '" /></a>', authortext:authortext};
			break;
		case "me":
			multiline = false;
			worktext = worktext.replace(/\n/g," ");
			break;
		case "call":
			var recipientText;
			if(parts.length == 1){
				recipientText = "all";
			}else{
				parts.shift();
				recipientText = parts.join(":").replace(/,/g,", ");
			}
			authortext = author + " calls "+ recipientText + ": ";
			break;
		case "notify":
			//
			break;
		case "cont":
			//
			break;
			
		//check for options
		case "logout":
			return {meta:'logout',html:'<strong>Special command to log out (will not send)</strong>', authortext:authortext};
			break;
		case "help":
			return {meta:'help',html:'<strong>Special command to show help (will not send)</strong>', authortext:authortext};
			break;
		case "hf":
			str = "hide header and footer";
			if(!verbose) str = "show header and footer as normal";
			return {meta:'hf',html:'<strong>Special command to '+str+' (will not send)</strong>', authortext:authortext};
			break;
		case "tone":
			str = "enable";
			if(!disableAlert) str = "disable";
			return {meta:'tone',html:'<strong>Special command to '+str+' the alert tone (will not send)</strong>', authortext:authortext};
			break;
		case "mute":
			str = "mute";
			if(mute) str = "unmute";
			return {meta:'tone',html:'<strong>Special command to '+str+' all sounds, including the call tone (will not send)</strong>', authortext:authortext};
			break;
		case "preview":
			str = "enable"
			if(dopreview)str = "disable";
			return {meta:'preview',html:'<strong>Special command to '+str+' the preview (will not send)</strong>', authortext:authortext};
			break;
		case "math":
			str = "enable"
			if(mathpreview)str = "disable";
			return {meta:'math',html:'<strong>Special command to '+str+' live previewing of math (will not send)</strong>', authortext:authortext};
			break;
		case "archive":
			str = 'Special command to retrieve the last 10 posts in the archive';
			if(retrieving||denyretrieve)str = "Archive retrieval denied, command disabled";
			return {meta:'archive',html:'<strong>'+str+' (will not send)</strong>', authortext:authortext};
			break;
		case "sync":
			str = 'Special command to synchronize the discussion in case you failed to recieve some messages';
			if(syncing)str = "Syncing in progress, command disabled";
			return {meta:'sync',html:'<strong>'+str+' (will not send)</strong>', authortext:authortext};
			break;
		case "upload":
			return {meta:'upload',html:'<strong>Special command to open upload dialog (will not send)</strong>', authortext:authortext};
			break;
		default:
			return {meta:meta,html:'<strong>Unknown tag &quot;'+parts[0]+'&quot;</span></strong>', authortext:authortext};
			break;
		}
	}
	if(worktext == "") worktext = " ";
	//find something formatted like a link
	worktext = "\r" + worktext + "\r";
	worktext = worktext.replace(/(\s(&gt;)*)((ht|f)tp(s?)\:\/\/[\S]*)(\s)/g,"$1[[$3]]$6");
	
	//hash code and math so we can do formatting on the rest
	var codehash = [];
	var mathhash = [];
	var linkhashname = [];
	var linkhashurl = [];
	var output = hashstuff(worktext,codehash,mathhash,linkhashname,linkhashurl)
	
	//do formatting
	var btags = '<strong>$1</strong>';
	var itags = '<em>$1</em>';
	var stags = '<span class="strikethrough">$1</span>';
	if(compress){
		btags = '<b$1b>';
		itags = '<i$1i>';
		stags = '<s$1s>';
	}
	output = output.replace(/\*\*([\s\S]*?)\*\*/g,btags).replace(/\*\*([\s\S]*?)$/,btags);
	output = output.replace(/\/\/([\s\S]*?)\/\//g,itags).replace(/\/\/([\s\S]*?)$/,itags)
	output = output.replace(/__([\s\S]*?)__/g,stags).replace(/__([\s\S]*?)$/,stags);
	
	
	if(multiline){
		//add quotes
		output = "\r" + output + "\r";
		output = output.replace(/([\r\n]&gt;.*?)+[\r\n]/g,function(savvyCode){return addQuotes(savvyCode,compress);});
		
		//add dot points
		output = "\r" + output + "\r";
		output = output.replace(/([\r\n]- .*?)+[\r\n]/g,function(savvyCode){return addDotPoints(savvyCode,compress);});
	}
	
	var citags = ['<span class="code">','</span>'];
	var cbtags = ['<pre class="code">','</pre>'];
	var atags = ['<a target="_blank" href="[[">','</a>'];
	var mitags = ['<span class="mathplaceholderinline">','</span>'];
	var mbtags = ['<div class="mathplaceholderblock">','</div>'];
	if(domath){
		mitags = ['\\(','\\)'];
		mbtags = ['$$',' $$'];
	}
	if(compress){
		citags = ['<c','c>'];
		cbtags = ['<x','x>'];
		atags = ['<a[[<>','a>'];
		mitags = ['<m','m>'];
		mbtags = ['<z','z>'];
	}
	
	//put back code
	if(multiline) output = "\r" + output + "\r";
	codeparts = output.split("`");
	output = interleave(codeparts,codehash,citags[0],citags[1],cbtags[0],cbtags[1]);
	
	//put back text part of links
	linkparts = output.split("[[");
	output = interleave(linkparts,linkhashname,atags[0],atags[1],atags[0],atags[1]);

	//put back links
	linkparts = output.split("[[");
	output = interleave(linkparts,linkhashurl,'','','','');
	
	//put back math
	if(multiline) output = "\r" + output + "\r";
	mathparts = output.split("$$");
	output = interleave(mathparts, mathhash,mitags[0],mitags[1],mbtags[0],mbtags[1]);
	
	//add newlines
	if(compress){
		output = output.replace(/\r/g,'').replace(/\n/g,'<r');
	}else{
		output = output.replace(/\r/g,'').replace(/\n/g,'<br />');
	}
	if(metahead == "me"){
		if(output.substr(0,1) != " ") output = " " + output;
		return {meta:meta,html:"",authortext:author + output};
	}
	return {meta:meta,html:output,authortext:authortext};
}

//recursive helper function that uses an undocumented feature of replace() to parse nested ">" quote tags
function addQuotes(savvyCode,compress){
	var content = savvyCode.replace(/([\n\r])&gt;/g,"$1").replace(/^\n|\n$/g,'').replace(/([\r\n]&gt;.*?)+[\r\n]/g,function(savvyCode){return addQuotes(savvyCode,compress);});
	if(content.replace(/\r/g,"") == ""){
		content = "<br />";
	}
	//is this a spoiler
	if(/^[\r\n]*&lt; *.*?[\n\r]/.test(content)){
		content = content.replace(/^[\r\n]*&lt; *(.*?)[\n\r]/,"")
		//this is a spoiler
		if(compress){
			return '\r<t' + RegExp.$1 + 't><p' + content + 'p>\r';
		}
		return '\r<blockquote><a onclick="if(this.nextSibling.style.display==&quot;none&quot;){this.nextSibling.style.display=&quot;block&quot;;scrollDown();}else{this.nextSibling.style.display=&quot;none&quot;}return false;" href="">Show/Hide <span class="collapsetitle">' + RegExp.$1 + '</span></a><div style="display:none;">' + content + '</div></blockquote>\r';
	}
	if(compress){
		return '\r<q\r' + content + '\rq>\r';
	}
	return '\r<blockquote>\r' + content + '\r</blockquote>\r';
}

function addDotPoints(savvyCode,compress){
	if(compress){
		return "<u" + savvyCode.replace(/[\r\n]/g,"\r\r").replace(/\r- (.*?)\r/g,"<l$1l>") + "u>"
	}
	return "<ul>" + savvyCode.replace(/[\r\n]/g,"\r\r").replace(/\r- (.*?)\r/g,"<li>$1</li>") + "</ul>"
}

//helper function that puts a hash back into the text
//has is tagged according to whether the code/math is isolated in a paragraph
function interleave(parts, hash, startSepLine, endSepLine, startSepBlock, endSepBlock){
	var progress = "";
	while(hash.length > 0){
		progress += parts.shift();
		if(/[\r\n]/.test(progress.charAt(progress.length-1)) && /[\r\n]/.test(parts[0].charAt(0))){
			progress += startSepBlock+hash.shift() + endSepBlock;
		}else{
			progress += startSepLine+hash.shift() + endSepLine;
		}
	}
	progress += parts[0];
	return progress;
}

//stop a keypress event from performing its default action
function stopBubble(e){
	//e.cancelBubble is supported by IE - this will kill the bubbling process.
	e.cancelBubble = true;
	e.returnValue = false;

	//e.stopPropagation works in Firefox.
	if (e.stopPropagation) {
		e.stopPropagation();
		e.preventDefault();
	}
	return false;
}

//check for keyboard shortcuts
function checkKeys(e){
	var code
	if (e.keyCode) code = e.keyCode;
	else code = e.which;
	var character = String.fromCharCode(code).toLowerCase();
	if(e.shiftKey && code == 13){
		sendPost();
		return stopBubble(e);
	}
	if(e.ctrlKey && character == 'i'){
		//italics
		insertAroundCursor(document.getElementById('composefield'), "//");
		return stopBubble(e);
	}
	if(e.ctrlKey && character == 'b'){
		//bold
		insertAroundCursor(document.getElementById('composefield'), "**");
		return stopBubble(e);
	}
	if(e.ctrlKey && character == 'q'){
		//quote
		quoteSelection(document.getElementById('composefield'))
		//insertAroundCursor(document.getElementById('composefield'), "**");
		return stopBubble(e);
	}
	return true;
}

function getSelectionPos(textarea){
	var output = {startPos:0, endPos:0};
	//IE support
	//figuring out the cursor position is stupid in IE
	if (document.selection) {
		textarea.focus();
		var sel = document.selection.createRange();
		var oldvalue = textarea.value.replace(/\r\n/g,"\n");
		var emptyflag = false
		if(sel.text == ""){
			emptyflag = true
			sel.text = String.fromCharCode(123456);//i hope nobody actually types this in
		}else{
			//cache text then modify it so I can search for its position
			if(sel.text.length == 1){
				sel.text = String.fromCharCode(sel.text.charCodeAt(0) + 1);
			}
			sel.text = String.fromCharCode(sel.text.charCodeAt(0) + 1)
			+ sel.text.substring(1, sel.text.length - 1)
			+ String.fromCharCode(sel.text.charCodeAt(sel.text.length - 1) + 1);
		}
		var newvalue = textarea.value.replace(/\r\n/g,"\n");
		for(var i = 0;i < oldvalue.length;i++){
			if(oldvalue.charAt(i) != newvalue.charAt(i)){
				output.startPos = i;
				break;
			}
		}
		if(emptyflag){
			output.endPos = output.startPos
		}else{
			for(i = oldvalue.length-1;i >= 0;i--){
				if(oldvalue.charAt(i) != newvalue.charAt(i)){
					output.endPos = i + 1;
					break;
				}
			}
		}
		textarea.value = oldvalue;
	}
	//MOZILLA/NETSCAPE support
	else if (textarea.selectionStart || textarea.selectionStart == '0') {
		output.startPos = textarea.selectionStart;
		output.endPos = textarea.selectionEnd;
	}
	return output;
}

function setSelectionPos(textarea, startPos, endPos){
	if(!endPos){
		endPos = startPos;
	}
	//IE support
	if (textarea.createTextRange) {
		textarea.focus();
		var sel = textarea.createTextRange()
		//sel.moveStart('character', -textarea.value.length);
		//sel.moveEnd('character', -textarea.value.length);
		//sel.moveStart('character', startPos);
		//sel.moveEnd('character', endPos);
		sel.move("character",startPos);
		sel.moveEnd('character', endPos - startPos);
		sel.select()
	}
	//MOZILLA/NETSCAPE support
	else if (textarea.selectionStart || textarea.selectionStart == '0') {
		textarea.selectionStart = startPos;
		textarea.selectionEnd = endPos;
	}
}

function quoteSelection(textarea){
	var selection = getSelectionPos(textarea);
	textvalue = textarea.value.replace(/\r\n/g,"\n");
	var pretext = textvalue.substring(0, selection.startPos);
	if(pretext.length > 0 && pretext.charAt(pretext.length-1) != "\n") pretext += "\n";
	var posttext = textvalue.substring(selection.endPos, textvalue.length);
	if(posttext.length > 0 && posttext.charAt(0) != "\n") posttext = "\n" + posttext;
	var quotetext = formatQuote(textvalue.substring(selection.startPos, selection.endPos))
	textarea.value = pretext + quotetext + posttext;
	if(selection.startPos == selection.endPos) setSelectionPos(textarea, pretext.length + 1);
	else setSelectionPos(textarea, pretext.length, pretext.length + quotetext.length);
}

//put bold and italics tags around the cursor
//http://alexking.org/blog/2003/06/02/inserting-at-the-cursor-using-javascript
function insertAroundCursor(textarea, tag) {
	//IE support
	if (document.selection) {
		textarea.focus();
		var sel = document.selection.createRange();
		if(sel.text == ""){
			sel.text = tag;
		}else{
			sel.text = tag + sel.text + tag;
		}
	}
	//MOZILLA/NETSCAPE support
	else if (textarea.selectionStart || textarea.selectionStart == '0') {
		var startPos = textarea.selectionStart;
		var endPos = textarea.selectionEnd;
		if(startPos == endPos){
			textarea.value = textarea.value.substring(0, startPos) + tag + textarea.value.substring(endPos, textarea.value.length);
			setSelectionPos(textarea, startPos + tag.length)
		}else{
			textarea.value = textarea.value.substring(0, startPos) + tag
			+ textarea.value.substring(startPos, endPos) + tag
			+ textarea.value.substring(endPos, textarea.value.length);
			setSelectionPos(textarea, startPos, endPos + tag.length * 2);
		}
	}
}

var scrollLocked = true;
var autoscrolling = false;
function scrolledDown(){
	var posts = document.getElementById("postlist");
	return posts.scrollTop == posts.scrollHeight - posts.offsetHeight;
}

//if user set the scroll to the bottom of the postlist, scroll down automatically
function scrollDown(){
	var posts = document.getElementById("postlist");
	if(posts.clientHeight < posts.scrollHeight){
		//scrollbar
		addClass(posts,"withscrollbar");
	}else{
		removeClass(posts,"withscrollbar");
	}
	if(scrollLocked){
		autoscrolling = true;//flag so that onscroll doesn't get called again
		posts.scrollTop = posts.scrollHeight - posts.offsetHeight;
		autoscrolling = false;
	}
}

function setScrollLock(){
	if(!autoscrolling){
		scrollLocked = scrolledDown();
	}
}

//called when the preview option box is checked
function togglePreview(checkbox){
	if(checkbox.checked){
		dopreview = true;
	}else{
		dopreview = false;
	}
	document.getElementById("previewpost").style.display = dopreview?"Block":"None";
	showPreview();
	scrollDown;
	MJQ([scrollDown]);
}

//called when the tone alert option box is checked
function toggleAlert(checkbox){
	if(checkbox.checked){
		disableAlert = false;
		sendMessage('/tone', {param: 'a=true'});
	}else{
		disableAlert = true;
		sendMessage('/tone', {param: 'a=false'});
	}
}

//in gadget mode
function expand(){
	//we don't want two alerts
	//document.getElementById("alertcheck").checked = false;
	//disableAlert = true;
}

var ww = 0;
var wh = 0;
//called onresize fits page content intelligently
//width and height are handled separately
function fitWindow(){
	var widthchanged = false;
	if(ww != windowWidth()){
		widthchanged = true;
		ww = windowWidth();
		if(ww >= 900){
			document.getElementById('content').style.width = "900px";
			document.getElementById('postlist').style.width = "880px";
			document.getElementById('composefield').style.width = "880px";
			document.getElementById('content').style.borderWidth = Math.min(Math.round((ww - 900)/2), 3) + "px";
		}else{
			padding = 20;
			if(gadget){
				padding = 0;
			}
			document.getElementById('postlist').style.width = ww - padding + "px";
			document.getElementById('composefield').style.width = ww - padding + "px";
			document.getElementById('content').style.borderWidth = "0px";
			document.getElementById('content').style.width = ww + "px";
			if(ww < 400){
				document.getElementById('postbutton').value = "Post";
				document.getElementById('postbutton').style.width = "60px";
				document.getElementById('previewchecklabel').innerHTML = "preview";
				document.getElementById('alertchecklabel').innerHTML = "tone";
				if(gadget){
					document.getElementById('alertchecklabel').innerHTML = "&#x266B;";
				}
			}else{
				document.getElementById('postbutton').value = "Post (Shift+Enter)";
				document.getElementById('postbutton').style.width = "150px";
				document.getElementById('previewchecklabel').innerHTML = "live preview&nbsp;&nbsp;";
				document.getElementById('alertchecklabel').innerHTML = "play alert tone";
			}
		}
		//refit images
		var images = document.getElementsByTagName('img');
		for(var i = 0; i < images.length; i++){
			images[i].style.width = "auto";
			naturalWidth = images[i].offsetWidth;
			images[i].style.width = "100%";
			if(images[i].offsetWidth > naturalWidth){
				images[i].style.width = "auto";
			}
		}
	}
	if(widthchanged || wh != windowHeight()){
		wh = windowHeight();
		var availablepx = wh;
		if(ww < 900 || wh < 600 || !verbose){
			document.getElementById('header').style.display = "None";
			document.getElementById('footer').style.display = "None";
		}else{
			document.getElementById('header').style.display = "Block";
			document.getElementById('footer').style.display = "Block";
			availablepx -= document.getElementById('header').offsetHeight;
			availablepx -= document.getElementById('footer').offsetHeight;
		}
		var apx2 = Math.min(Math.max(0,wh-525),75);
		apx2 -= Math.round(apx2/3);
		document.getElementById('postbutton').style.height = 25+Math.round(apx2/3)+"px";
		document.getElementById('composefield').style.height = apx2+50+"px";
		availablepx -= document.getElementById('compose').offsetHeight + document.getElementById('topic').offsetHeight + 15 + 20;
		document.getElementById('postlist').style.height = availablepx+"px";
	}
	scrollDown();
}

var mInt;
function marquee(){
	mInt = setInterval("document.getElementById('topic').scrollLeft += 4;",50);
}
function unmarquee(){
	clearInterval(mInt);
	document.getElementById('topic').scrollLeft = 0;
}

function onLoadBody(){
	//this is the stuff we want to call after all the page has been loaded
	MJQT("dummy");//hack to fix a mathjax bug
		
	//display all the elements that were hidden while loading
	document.getElementById("container").style.display="block";
	document.getElementById("loadingContainer").style.display="None";
	
	document.getElementById("previewcheck").checked = dopreview;
	togglePreview(document.getElementById("previewcheck"));
	document.getElementById("alertcheck").checked = !disableAlert;
	
	document.getElementById("authorpreview").innerHTML = username+":";
	
	//size everything
	fitWindow();
	ww = 0;
	wh = 0;
	setTimeout("fitWindow();",100);//some browsers require a few ms to set up the page before resizing can take place
	if(!gadget) window.onresize = fitWindow;
	
	window.onbeforeunload = function(){
		//this is flaky
		sendMessage('/closed', {param: 'u=' + userid + '&t=' + tokenid});
	}
	
	scrollDown();
	setInterval("scrollDown();showPreview();",300);
	//showPreview();
	//that shouldnt actually be necessary because scrolldown is automatically called whenever something could scroll the page
	
	if(gadget){
		//hide the preview option
		document.getElementById("supercheckpreview").style.display="None";
	}
	
	//set up the infrastructure to play audio
	if(typeof(Audio) == 'undefined'){
		document.getElementById("dummy").innerHTML += '<bgsound id="IEsound" />';
	}else{
		sounds["alert"] = new Audio("sounds/alert.wav");
		sounds["error"] = new Audio("sounds/error.wav");
		sounds["call"] = new Audio("sounds/call.wav");
	}
	
	//parse topic
	var parsedObj = getHTMLfromSavvyCode(document.getElementById("topic").innerHTML, true, "");
	document.getElementById("topic").innerHTML = parsedObj.html;
	MJQT("topic");
	
	//keyboard shortcuts
	var textarea=document.getElementById("composefield")
	var etype="keydown"
	//different browsers require different methods to attach the event
	if(textarea.addEventListener) textarea.addEventListener(etype, checkKeys, false);
		else if(textarea.attachEvent) textarea.attachEvent('on'+etype, checkKeys);
		else textarea['on'+etype] = checkKeys;
	
	//file upload
	document.getElementById("uploadform").onsubmit = function() {
		document.getElementById("uploadform").target = "uploadtarget";
		hideUpload();
		//loadiFrame = displayUpload;
	}
	document.getElementById("uploadinput").value = "";
	document.getElementById("uploadbutton").disabled = true;
	//hideUpload();
	
	//parse initial posts
	var ip = document.getElementById("initialposts").childNodes;
	for(var i=ip.length-1;i>=0;i--){
		unescapedContent=ip[i].childNodes[1].innerHTML.replace(/&quot;/g,'"').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');
		var recipients=[];
		for(var j=3;j<ip[i].childNodes.length;j++){
			recipients.push(ip[i].childNodes[j].innerHTML);
		}
		recievePost({author:ip[i].childNodes[0].innerHTML, content:unescapedContent, date:ip[i].childNodes[2].innerHTML, recipients:recipients},true);
	}
	
	setIcon();//maybe this should be *before* page load...
	
	openChannel();
}

//display the url of the uploaded object
function displayUpload(){
	var data = frames['uploadtarget'].document.getElementsByTagName("body")[0].innerHTML;
	hideUpload();
	/\.(.*)$/.exec(data);
	var e = RegExp.$1;
	var path = document.location.href.replace(/[^/]*$/,"") + data;
	var str = "[[" + path + "]]";
	if(e=="png"||e=="jpg"||e=="jpeg"||e=="gif"||e=="bmp"){
		str = "|img|"+path;
	}
	document.getElementById("composefield").value = str;
	showPreview();
}

function onBlur (){
	windowFocus = false;
}
function onFocus(){
	windowFocus = true;
	if(alerted){
		setIcon("favicon.ico");
		//chrome bug: http://heyman.info/2010/oct/7/google-chrome-bug-when-setting-document-title/
		setTimeout(function() {
				document.title = "SavvyChat";
			}, 100);
		alerted = false;
	}
}
//these need to be set outside of onloadbody lest it get out of sync before the page loads
if(document.onfocusin === null){
	//IE needs its own special method to detect window focus or it gets confused with the textarea, poor mentally disabled child
	document.onfocusin = onFocus;
	document.onfocusout = onBlur;
}else{
	window.onfocus = onFocus;
	window.onblur = onBlur;
}

//for gadget only
function goToView(dest) { 
	var supported_views = gadgets.views.getSupportedViews(); 
	gadgets.views.requestNavigateTo(supported_views[dest]); 
}
</script>
{% if gadget %}
<!--I copied the following from the twitter gadget, got no idea what it does-->
<script type="text/javascript" src='http://www.gmodules.com/gadgets/js/{{ libs }}?v={{ v }}&container={{ container }}&debug=0'></script>
<script type="text/javascript">gadgets.config.init({"rpc":{"useLegacyProtocol":false,"parentRelayUrl":"/rpc_relay.html"},"views":{"profile":{"aliases":["DASHBOARD","default"],"isOnlyVisible":false,"urlTemplate":"http://localhost/gadgets/profile?{var}"},"canvas":{"aliases":["FULL_PAGE"],"isOnlyVisible":true,"urlTemplate":"http://localhost/gadgets/canvas?{var}"}},"core.util":{"flash":{},"dynamic-height":{},"views":{},"setprefs":{},"maximize":{},"opensocial-0.8":{},"tabs":{}},"core.io":{"proxyUrl":"http://www.gmodules.com/gadgets/proxy/refresh=%refresh%&container=%container%&gadget=%gadget%/%url%","jsonProxyUrl":"http://%host%/gadgets/makeRequest"},"opensocial-0.8":{"domain":"google.com","path":"http://%host%/api","supportedFields":{"person":["id","name","thumbnailUrl","nickname"],"filterType":["all","hasApp"],"activity":["id","externalId","userId","appId","streamTitle","streamUrl","streamSourceUrl","streamFaviconUrl","title","body","url","mediaItems","postedTime"],"activityMediaItem":["type","mimeType","url"],"sortOrder":["name"],"name":["unstructured","familyName","givenName","additionalName","honorificPrefix, honorificSuffix"]},"impl":"rpc","enableCaja":false}});</script>
{% endif %}
<title>SavvyChat</title>
</head>
<body onload="onLoadBody();">
<div id="loadingContainer">
	<div id="loadingContent">
		<div>
			<h1>SavvyChat</h1>
		</div>
		<noscript>
			<div style="padding:10px;text-align:center;background-color:#D75;">Your browser does not support Javascript. You cannot use SavvyChat.</div>
		</noscript>
		{% if not disableMath %}<div id="loadingmessage" style="padding:10px;text-align:center;display:none">Click {% if gadget %}<a href="?disableMath=true&gadget=true">here</a> to load the gadget{% else %}<a href="?disableMath=true">here</a> to load the page{% endif %} without math.</div>
		<script type="text/javascript">document.getElementById('loadingmessage').style.display = "Block";</script>{% endif %}
	</div>
</div>

<div id="container">
	<div id="content">
		<div id="header">
			<h1>SavvyChat <span class="sup" style="position:absolute;color:#999">beta</span></h1>
			<div id="subtitle">{{ subtitle }}</div>
			<div id="helpTag"><a onclick="return openHelp('');" href="help.htm">Help</a></div>
			<div id="logoutTag"><a onclick="logout();return false;" href="{{ logouturl }}">Logout</a></div>
		</div>
		<div id="archive">
		<div onmouseover="marquee();" onmouseout="unmarquee();" id="topic">{{ topic }}</div>
		<div id="postlist" onscroll="setScrollLock();">
			{% if showarchive %}
			<div id="viewarchivetag" class="post" style="text-align:center;font-weight:bold;margin-top:0;"><a href="" onclick="retrieveArchive();return false;">^ view older ^</a></div>
			{% endif %}
			<div id="archivelist"></div>
			
			<div class="post" id="previewpost"><div id="previewlabel">(preview)</div><span class="author" id="authorpreview"></span><span class="postcontent" id="preview"></span></div>
		</div>
		</div>
		<div id="compose">
			<!--<form id="composeform" onsubmit="sendPost(); return false;">-->
			<div id="controls">
			<form id="uploadform" action="/upload" enctype="multipart/form-data" method="post" style="display:none;position:absolute;"><div>
				<input id="uploadinput" type="file" name="file" onchange="validateFile();" /><br />
				<input id="uploadbutton" type="submit" value="upload" />
				<input type="button" value="cancel" onclick="hideUpload();"/>
				<iframe onload="loadiFrame();" id="uploadtarget" name="uploadtarget" src="" style="display:none"></iframe>
			</div></form>
			<div><textarea id="composefield" onkeyup="showPreview();" autofocus="autofocus"></textarea></div>
			<div><input id="postbutton" type="button" value="Post (Shift+Enter)" onclick="sendPost();">&nbsp;&nbsp;
			<span id="supercheckpreview"><input id="previewcheck" type="checkbox" onclick="togglePreview(this);" /><label for="previewcheck" id="previewchecklabel">live preview&nbsp;&nbsp;</label></span><input id="alertcheck" type="checkbox" onclick="toggleAlert(this);" /><label for="alertcheck" id="alertchecklabel">play alert tone</label>
			{% if gadget %}
			&nbsp;&nbsp;<a onclick="expand();" href="javascript:window.open('http://savvychat.appspot.com');">Expand</a>
			{% endif %}
				</div></div>
			<!--</form>-->
		</div>
		<div id="footer">
			SavvyChat was built with the <a href="http://code.google.com/appengine/">Google App Engine SDK</a> by <a href="mailto:fearthekwan@gmail.com">Matthew Kwan</a> for private use. Last update was on 8 Mar 2011.
		</div>
	</div>
</div>
<div id="dummy" style="display:none;">$$$$</div>
<!--The following is a dummy div where all the initial posts can be dumped while escaping unicode etc-->
<pre id="initialposts" style="display:none;">{% for post in posts %}<pre><pre>{{ post.author }}</pre><pre>{{ post.content|escape }}</pre><pre>{{ post.date }}</pre>{% for recipient in post.recipients %}<pre>{{ recipient }}</pre>{% endfor %}</pre>{% endfor %}</pre>

</body>
</html>